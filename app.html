
// --- GESTIONE FOTO CON ANTEPRIMA ---
window.handleImagePreview = (f) => {
    if(!f) return; 
    const reader = new FileReader(); 
    reader.readAsDataURL(f);
    reader.onload = (e) => {
        Swal.fire({
            title: 'INVIARE QUESTA FOTO?',
            html: `<img src="${e.target.result}" style="width:100%; border-radius:1rem; margin-top:10px;">`,
            showCancelButton: true,
            confirmButtonText: 'INVIA',
            cancelButtonText: 'ANNULLA'
        }).then(async (result) => {
            if (result.isConfirmed) {
                const p = await getGPS();
                push(ref(db, 'brogliaccio'), { 
                    ora: new Date().toLocaleTimeString('it-IT').slice(0,5), 
                    squadra: sqId, m1: "ðŸ“· FOTO [SQUADRA]", 
                    mediaUrl: e.target.result, mediaType: 'IMG', 
                    dir: 'SQ', stato: 'ATTESA', lat: p.lat, lng: p.lng 
                });
                Swal.fire({ icon:'success', title:'FOTO INVIATA', toast:true, position:'top', timer:1500, showConfirmButton:false });
            }
        });
    };
};

// --- GESTIONE AUDIO CON ANTEPRIMA ---
let mediaRecorder; let audioChunks = [];
document.getElementById('btn-audio').onclick = async () => {
    const btn = document.getElementById('btn-audio');
    const label = document.getElementById('audio-label');
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(s); audioChunks = [];
        mediaRecorder.onstart = () => { btn.classList.add('recording-active'); label.innerText = "REGISTRO..."; };
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            btn.classList.remove('recording-active'); label.innerText = "VOCALE";
            const b = new Blob(audioChunks, { type: 'audio/mp3' });
            const audioUrl = URL.createObjectURL(b);
            Swal.fire({
                title: 'INVIARE VOCALE?',
                html: `<audio controls src="${audioUrl}" style="width:100%; margin-top:10px;"></audio>`,
                showCancelButton: true,
                confirmButtonText: 'INVIA',
                cancelButtonText: 'RIFAI'
            }).then(async (res) => {
                if (res.isConfirmed) {
                    const r = new FileReader(); r.readAsDataURL(b);
                    r.onloadend = async () => {
                        const p = await getGPS();
                        push(ref(db, 'brogliaccio'), { 
                            ora: new Date().toLocaleTimeString('it-IT').slice(0,5), 
                            squadra: sqId, m1: "ðŸŽ¤ VOCALE [SQUADRA]", 
                            mediaUrl: r.result, mediaType: 'AUDIO', 
                            dir: 'SQ', stato: 'ATTESA', lat: p.lat, lng: p.lng 
                        });
                        Swal.fire({ icon:'success', title:'VOCALE INVIATO', toast:true, position:'top', timer:1500, showConfirmButton:false });
                    };
                }
            });
        };
        mediaRecorder.start();
    } else { mediaRecorder.stop(); }
};
