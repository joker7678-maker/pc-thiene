<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC THIENE - APP COMMUNICATION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #020617; font-family: 'Inter', sans-serif; color: white; }
        .btn-status { transition: all 0.2s; border-bottom: 4px solid rgba(0,0,0,0.4); }
        .btn-status:active { transform: translateY(2px); border-bottom-width: 2px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #1e293b; transition: .4s; border-radius: 34px; border: 1px solid #334155; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; border-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(22px); }
        .online-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .is-online { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .is-offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="p-4 flex flex-col min-h-screen">

    <header class="flex justify-between items-center mb-6 border-b-2 border-blue-600 pb-4">
        <div class="flex flex-col">
            <h1 class="text-xl font-black text-white uppercase leading-none tracking-tighter">
                PROTEZIONE CIVILE<br>
                <span class="text-blue-500 text-2xl">THIENE</span>
            </h1>
            <div class="flex items-center mt-1">
                <span class="text-[9px] font-bold text-blue-400 uppercase tracking-[0.2em]">App Communication System</span>
            </div>
        </div>
        <div class="flex flex-col items-end">
            <div class="glass px-3 py-1.5 rounded-lg flex items-center gap-2">
                <span id="sala-dot" class="online-dot is-offline"></span>
                <span id="sala-status" class="text-[10px] font-black uppercase text-slate-400">Sala Offline</span>
            </div>
            <p id="label-squadra" class="text-[11px] font-bold text-slate-500 font-mono mt-1 uppercase">Unit: ---</p>
        </div>
    </header>

    <main class="flex-1 flex flex-col gap-4 max-w-md mx-auto w-full">
        
        <div id="box-risposta" class="hidden transform transition-all">
            <div class="bg-blue-600 border-l-4 border-white p-4 rounded-r-xl shadow-lg shadow-blue-900/40">
                <p class="text-[10px] font-black uppercase text-blue-100 mb-1 tracking-widest">Messaggio Ricevuto dalla Sala:</p>
                <p id="testo-risposta" class="text-md font-bold text-white leading-tight italic"></p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="window.statoRapido('IN PARTENZA üöö', 'Uscita')" class="btn-status bg-amber-500 p-4 rounded-xl font-black text-xs uppercase text-slate-950 shadow-lg">üöö Partenza</button>
            <button onclick="window.statoRapido('SUL POSTO üö®', 'Intervento')" class="btn-status bg-red-600 p-4 rounded-xl font-black text-xs uppercase text-white shadow-lg">üö® Sul Posto</button>
            <button onclick="window.statoRapido('OPERATIVI ‚ö°', 'In Corso')" class="btn-status bg-blue-600 p-4 rounded-xl font-black text-xs uppercase text-white shadow-lg">‚ö° Operativi</button>
            <button onclick="window.statoRapido('RIENTRO üè†', 'Rientro')" class="btn-status bg-emerald-600 p-4 rounded-xl font-black text-xs uppercase text-white shadow-lg">üè† Rientro</button>
        </div>

        <div class="flex flex-col gap-1 mt-2">
            <label class="text-[10px] font-black text-slate-500 uppercase ml-1 tracking-widest">Comunicazione Libera</label>
            <textarea id="messaggio" rows="3" 
                class="w-full p-4 bg-slate-900 border-2 border-slate-800 rounded-xl text-white font-bold focus:border-blue-500 outline-none resize-none shadow-inner" 
                placeholder="Inserisci note o dettagli..."></textarea>
        </div>

        <div class="glass flex items-center justify-between p-4 rounded-xl">
            <div class="flex flex-col">
                <span class="text-xs font-black uppercase tracking-wide">Posizione GPS</span>
                <span class="text-[9px] text-slate-500 font-bold">Invia coordinate alla sala</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="toggle-gps" checked>
                <span class="slider"></span>
            </label>
        </div>

        <button id="btn-invia" onclick="window.inviaDati()" 
            class="w-full py-5 bg-white text-slate-950 rounded-xl font-black text-xl uppercase transition-all shadow-2xl active:scale-95 border-b-4 border-slate-300">
            Invia Report
        </button>
    </main>

    <footer class="mt-8 text-center opacity-20">
        <p class="text-[8px] font-black tracking-[0.3em] uppercase">Thiene SO Master Terminal v78.31</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, update, onValue, query, orderByChild, equalTo, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAWHRpXkth-UrnaDVo7GyeFNXpu10_fd54", databaseURL: "https://realtime-database-6962f-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const squadraId = urlParams.get('id') ? urlParams.get('id').toUpperCase() : "SCONOSCIUTA";
        document.getElementById('label-squadra').innerText = "Unit: " + squadraId;

        onValue(ref(db, ".info/connected"), (snap) => {
            const dot = document.getElementById('sala-dot');
            const txt = document.getElementById('sala-status');
            if (snap.val()) {
                dot.className = "online-dot is-online";
                txt.innerText = "Sala Online";
                txt.className = "text-[10px] font-black uppercase text-emerald-400";
            } else {
                dot.className = "online-dot is-offline";
                txt.innerText = "Sala Offline";
                txt.className = "text-[10px] font-black uppercase text-red-500";
            }
        });

        const logRef = query(ref(db, 'brogliaccio'), orderByChild('squadra'), equalTo(squadraId), limitToLast(5));
        onValue(logRef, (snap) => {
            const logs = snap.val();
            if (logs) {
                const lastLog = Object.values(logs).reverse().find(l => l.m2 && l.m2 !== "---");
                if (lastLog) {
                    document.getElementById('box-risposta').classList.remove('hidden');
                    document.getElementById('testo-risposta').innerText = lastLog.m2;
                    if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
                }
            }
        });

        window.statoRapido = (testoStato, valoreStato) => {
            const extra = document.getElementById('messaggio').value.trim();
            const messaggioFinale = extra ? `${testoStato} | ${extra}` : testoStato;
            window.inviaDati(messaggioFinale, valoreStato);
        };

        window.inviaDati = async (msgForzato = null, statoForzato = null) => {
            const msgInput = document.getElementById('messaggio');
            const btn = document.getElementById('btn-invia');
            const gpsEnabled = document.getElementById('toggle-gps').checked;
            const testo = msgForzato || msgInput.value.trim();

            if (!testo) return;

            btn.disabled = true;
            btn.innerText = "TRASMISSIONE...";

            if (gpsEnabled) {
                navigator.geolocation.getCurrentPosition(
                    async (p) => { await spedisci(testo, p.coords.latitude, p.coords.longitude, statoForzato); },
                    async () => { await spedisci(testo, "", "", statoForzato); },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                await spedisci(testo, "", "", statoForzato);
            }
        };

        async function spedisci(m, la, lo, nuovoStato) {
            try {
                const ora = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                await push(ref(db, 'brogliaccio'), {
                    ora, squadra: squadraId, m1: m, m2: "", lat: la || "", lng: lo || "", stato: 'ATTESA', dir: 'SQ'
                });
                const updates = {};
                if (la && lo) { updates.lat = la; updates.lng = lo; }
                if (nuovoStato) { updates.stato = nuovoStato; }
                if (Object.keys(updates).length > 0) await update(ref(db, `anagrafica_squadre/${squadraId}`), updates);
                document.getElementById('messaggio').value = "";
                Swal.fire({ icon: 'success', title: 'REPORT TRASMESSO', timer: 1000, showConfirmButton: false, position: 'top', background: '#0f172a', color: '#fff' });
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'ERRORE INVIO' });
            } finally {
                const btn = document.getElementById('btn-invia');
                btn.disabled = false;
                btn.innerText = "INVIA REPORT";
            }
        }
    </script>
</body>
</html>
