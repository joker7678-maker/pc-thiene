<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC THIENE - App Operatore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .btn-status { transition: all 0.2s; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); }
        .btn-status:active { transform: scale(0.95); opacity: 0.8; }
        #visualizer.recording { display: flex !important; }
        .bar { width: 3px; height: 8px; background: #ef4444; border-radius: 2px; animation: pulse 0.6s infinite ease-in-out; }
        @keyframes pulse { 50% { height: 20px; } }
    </style>
</head>
<body class="p-4 pb-10">

    <header class="flex justify-between items-center mb-5">
        <div>
            <h1 class="text-xl font-black tracking-tighter leading-none text-white">PC THIENE</h1>
            <p id="sq-display" class="text-blue-500 font-black text-[10px] uppercase tracking-widest mt-1 italic">SQUADRA...</p>
        </div>
        <div class="bg-emerald-500/20 text-emerald-500 text-[9px] font-bold px-2 py-0.5 rounded-full border border-emerald-500/30">ONLINE</div>
    </header>

    <div class="bg-slate-800/40 border border-slate-700/50 rounded-2xl p-4 mb-5 shadow-xl">
        <label class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-3 block text-center">Aggiornamento Stato Operativo</label>
        <div class="grid grid-cols-3 gap-2">
            <button onclick="window.confirmStatus('Partenza', 'ðŸšš')" class="btn-status bg-slate-700 text-white py-2.5 rounded-xl shadow-sm">Partenza</button>
            <button onclick="window.confirmStatus('In Corso', 'ðŸš¨')" class="btn-status bg-amber-500 text-black py-2.5 rounded-xl shadow-sm">In Corso</button>
            <button onclick="window.confirmStatus('Arrivo Posto', 'ðŸ“')" class="btn-status bg-indigo-500 text-white py-2.5 rounded-xl shadow-sm">Arrivo Posto</button>
            <button onclick="window.confirmStatus('Rientro', 'ðŸ”™')" class="btn-status bg-cyan-500 text-black py-2.5 rounded-xl shadow-sm">Rientro</button>
            <button onclick="window.confirmStatus('Disponibile', 'âœ…')" class="btn-status bg-emerald-600 text-white py-2.5 rounded-xl shadow-sm text-[9px]">Disp.</button>
            <button onclick="window.confirmStatus('Fine Servizio', 'ðŸ')" class="btn-status bg-red-800 text-white py-2.5 rounded-xl shadow-sm">Fine Serv.</button>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-5">
        <div onclick="document.getElementById('input-foto').click()" class="cursor-pointer bg-white text-black rounded-2xl p-4 flex flex-col items-center justify-center gap-1 shadow-md active:scale-95 transition-all">
            <span class="text-3xl">ðŸ“·</span>
            <span class="font-black text-[10px] uppercase">Foto</span>
            <input type="file" id="input-foto" accept="image/*" capture="camera" class="hidden" onchange="window.handleFile(this.files[0], 'IMG')">
        </div>
        <div id="btn-audio" class="cursor-pointer bg-red-600 text-white rounded-2xl p-4 flex flex-col items-center justify-center gap-1 shadow-md active:scale-95 transition-all">
            <span id="audio-icon" class="text-3xl">ðŸŽ¤</span>
            <span id="audio-label" class="font-black text-[10px] uppercase">Audio</span>
        </div>
    </div>

    <div id="visualizer" class="hidden mb-5 h-8 bg-slate-900/80 border border-slate-700 rounded-xl items-center justify-center gap-1">
        <div class="bar"></div><div class="bar" style="animation-delay:0.1s"></div><div class="bar" style="animation-delay:0.2s"></div>
        <div class="bar" style="animation-delay:0.3s"></div><div class="bar" style="animation-delay:0.4s"></div>
    </div>

    <div class="bg-slate-800/40 border border-slate-700/50 rounded-2xl p-4 shadow-xl">
        <textarea id="msg-input" class="w-full bg-slate-950 border border-slate-700/50 rounded-xl p-3 text-white font-bold h-20 mb-3 text-sm resize-none focus:border-blue-500 outline-none shadow-inner" placeholder="Scrivi note qui..."></textarea>
        <button onclick="window.sendTextLog()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl uppercase tracking-widest text-xs shadow-md">Invia Rapporto</button>
    </div>

    <footer class="mt-8 text-center opacity-30">
        <p class="text-[8px] font-black italic">JoKART 2026 - SCADENZA SESSIONE 24H</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const cfg = { 
            apiKey: "AIzaSyAWHRpXkth-UrnaDVo7GyeFNXpu10_fd54", 
            databaseURL: "https://realtime-database-6962f-default-rtdb.firebaseio.com", 
            projectId: "realtime-database-6962f"
        };
        const app = initializeApp(cfg);
        const db = getDatabase(app);
        
        const urlParams = new URLSearchParams(window.location.search);
        const sqId = urlParams.get('id') || "SCONOSCIUTA";
        document.getElementById('sq-display').innerText = sqId;

        // SCADENZA 24H
        const checkSession = () => {
            const now = Date.now();
            const start = localStorage.getItem('pc_session_start');
            if(!start) localStorage.setItem('pc_session_start', now);
            else if((now - start) > 24*60*60*1000) {
                localStorage.clear();
                window.location.reload();
            }
        };
        checkSession();

        window.confirmStatus = (status, emoji) => {
            Swal.fire({
                title: emoji, text: `Confermi "${status.toUpperCase()}"?`,
                icon: 'question', showCancelButton: true, confirmButtonText: 'SÃŒ', cancelButtonText: 'NO',
                background: '#1e293b', color: '#fff'
            }).then((res) => {
                if (res.isConfirmed) {
                    update(ref(db, `anagrafica_squadre/${sqId}`), { stato: status });
                    push(ref(db, 'brogliaccio'), {
                        ora: new Date().toLocaleTimeString('it-IT').slice(0,5),
                        squadra: sqId, dir: 'SQ', m1: `ðŸ”„ STATO: ${status.toUpperCase()}`, stato: 'OK'
                    });
                }
            });
        };

        window.handleFile = (file, type) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            Swal.fire({ title: 'Invio...', background: '#1e293b', color: '#fff', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            reader.onload = () => {
                push(ref(db, 'brogliaccio'), {
                    ora: new Date().toLocaleTimeString('it-IT').slice(0,5),
                    squadra: sqId, dir: 'SQ',
                    m1: type === 'IMG' ? 'ðŸ“· FOTO' : 'ðŸŽ¤ AUDIO',
                    mediaUrl: reader.result, mediaType: type, stato: 'ATTESA'
                }).then(() => Swal.close());
            };
        };

        let recorder; let chunks = [];
        const btnAudio = document.getElementById('btn-audio');
        btnAudio.onclick = async () => {
            if (!recorder || recorder.state === "inactive") {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => window.handleFile(new Blob(chunks, { type: 'audio/mp3' }), 'AUDIO');
                recorder.start();
                document.getElementById('visualizer').classList.add('recording');
                document.getElementById('audio-label').innerText = "STOP";
            } else {
                recorder.stop();
                document.getElementById('visualizer').classList.remove('recording');
                document.getElementById('audio-label').innerText = "AUDIO";
            }
        };

        window.sendTextLog = () => {
            const m = document.getElementById('msg-input').value;
            if(!m) return;
            push(ref(db, 'brogliaccio'), {
                ora: new Date().toLocaleTimeString('it-IT').slice(0,5),
                squadra: sqId, dir: 'SQ', m1: m, stato: 'ATTESA'
            });
            document.getElementById('msg-input').value = "";
            Swal.fire({ icon:'success', title:'Inviato', timer: 1000, showConfirmButton:false, background:'#1e293b', color:'#fff' });
        };
    </script>
</body>
</html>
