<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC THIENE - App Operatore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .btn-status { transition: all 0.2s; }
        .btn-status:active { transform: scale(0.95); }
        /* Animazione per il caricamento */
        .loading-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-4 pb-10">

    <header class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-2xl font-black tracking-tighter leading-none">PC THIENE</h1>
            <p id="sq-display" class="text-blue-500 font-black text-xs uppercase tracking-widest mt-1 italic">SQUADRA...</p>
        </div>
        <div id="net-status" class="bg-emerald-500/20 text-emerald-500 text-[10px] font-bold px-3 py-1 rounded-full border border-emerald-500/30">ONLINE</div>
    </header>

    <div class="bg-slate-800/50 border border-slate-700 rounded-3xl p-5 mb-6 shadow-2xl">
        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 block">Stato Squadra</label>
        <div id="current-status" class="text-3xl font-black text-white mb-5 uppercase italic tracking-tighter">Attesa...</div>
        
        <div class="grid grid-cols-2 gap-3">
            <button onclick="window.updateStatus('In Corso')" class="btn-status bg-amber-500 text-black font-black py-4 rounded-2xl text-xs uppercase shadow-lg">ðŸš¨ In Corso</button>
            <button onclick="window.updateStatus('Rientro')" class="btn-status bg-cyan-500 text-black font-black py-4 rounded-2xl text-xs uppercase shadow-lg">ðŸ”™ Rientro</button>
        </div>
    </div>

    <div class="mb-6">
        <div onclick="document.getElementById('input-foto').click()" class="cursor-pointer bg-white text-black rounded-3xl p-8 flex flex-col items-center justify-center gap-3 shadow-xl active:scale-95 transition-transform border-4 border-blue-600/20">
            <span class="text-5xl">ðŸ“·</span>
            <span class="font-black text-sm uppercase tracking-tighter">Invia Foto Segnalazione</span>
            <p class="text-[9px] font-bold text-slate-400 uppercase">Acquisizione rapida e invio</p>
            <input type="file" id="input-foto" accept="image/*" capture="camera" class="hidden" onchange="window.caricaFotoBase64(this.files[0])">
        </div>
    </div>

    <div class="bg-slate-800/50 border border-slate-700 rounded-3xl p-5 shadow-xl">
        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Rapporto Radio / Note</label>
        <textarea id="msg-input" class="w-full bg-slate-950 border border-slate-700 rounded-2xl p-4 text-white text-base font-bold outline-none focus:border-blue-500 transition-colors h-28 mb-4 resize-none" placeholder="Scrivi alla Sala Radio..."></textarea>
        <button onclick="window.sendTextLog()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl uppercase tracking-widest text-sm shadow-lg shadow-blue-600/30">Invia Messaggio</button>
    </div>

    <footer class="mt-10 text-center opacity-40">
        <p class="text-[9px] font-bold uppercase tracking-[0.3em]">System Manager TETRA</p>
        <p class="text-sm font-black italic">JoK<span class="text-red-600">ART</span> 2026</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const cfg = { 
            apiKey: "AIzaSyAWHRpXkth-UrnaDVo7GyeFNXpu10_fd54", 
            databaseURL: "https://realtime-database-6962f-default-rtdb.firebaseio.com", 
            projectId: "realtime-database-6962f"
        };

        const app = initializeApp(cfg);
        const db = getDatabase(app);

        // Identificazione Squadra via URL
        const urlParams = new URLSearchParams(window.location.search);
        const sqId = urlParams.get('id') || "SQUADRA NON DEFINITA";
        document.getElementById('sq-display').innerText = sqId;

        // Monitoraggio Stato
        onValue(ref(db, `anagrafica_squadre/${sqId}`), (snap) => {
            const val = snap.val();
            if(val) document.getElementById('current-status').innerText = val.stato;
        });

        // Funzione Cambio Stato
        window.updateStatus = (s) => {
            update(ref(db, `anagrafica_squadre/${sqId}`), { stato: s });
            push(ref(db, 'brogliaccio'), {
                ora: new Date().toLocaleTimeString('it-IT').slice(0,5),
                squadra: sqId,
                dir: 'SQ',
                m1: `ðŸ”„ CAMBIO STATO: ${s.toUpperCase()}`,
                stato: 'OK'
            });
            Swal.fire({ icon:'success', title: s, timer: 1000, showConfirmButton:false, toast:true, position:'top' });
        };

        // Funzione Invia Testo
        window.sendTextLog = () => {
            const m = document.getElementById('msg-input').value;
            if(!m) return;
            push(ref(db, 'brogliaccio'), {
                ora: new Date().toLocaleTimeString('it-IT').slice(0,5),
                squadra: sqId,
                dir: 'SQ',
                m1: m,
                stato: 'ATTESA'
            });
            document.getElementById('msg-input').value = "";
            Swal.fire({ icon:'success', title:'Inviato', timer: 1000, showConfirmButton:false, toast:true, position:'top' });
        };

        // FUNZIONE FOTO BASE64 (Piano Gratuito)
        window.caricaFotoBase64 = (file) => {
            if(!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            Swal.fire({ title: 'Compressione Foto...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    // Ridimensionamento per Database
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Base64 JPG con qualitÃ  0.6 per stare sotto i limiti di dimensione
                    const base64data = canvas.toDataURL('image/jpeg', 0.6);

                    push(ref(db, 'brogliaccio'), {
                        ora: new Date().toLocaleTimeString('it-IT').slice(0,5),
                        squadra: sqId,
                        dir: 'SQ',
                        m1: 'ðŸ“· [FOTO DAL CAMPO]',
                        mediaUrl: base64data,
                        mediaType: 'IMG',
                        stato: 'ATTESA'
                    }).then(() => {
                        Swal.fire({ icon:'success', title:'Foto Inviata!', timer: 1500, showConfirmButton:false });
                    }).catch(err => {
                        Swal.fire('Errore', 'Dati troppo pesanti', 'error');
                    });
                };
            };
        };
    </script>
</body>
</html>
