<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC THIENE - App Squadra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #020617; font-family: 'Inter', sans-serif; color: white; }
        .btn-status { transition: all 0.2s; border-bottom: 4px solid rgba(0,0,0,0.3); }
        .btn-status:active { transform: translateY(2px); border-bottom-width: 2px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(22px); }
        .online-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .is-online { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .is-offline { background: #ef4444; }
    </style>
</head>
<body class="p-4 flex flex-col min-h-screen">

    <header class="flex justify-between items-start mb-4">
        <div class="flex flex-col">
            <h1 class="text-xl font-black text-blue-500 uppercase tracking-tighter">PC THIENE</h1>
            <p id="label-squadra" class="text-sm font-bold text-slate-400 font-mono">ID: ---</p>
        </div>
        <div class="flex flex-col items-end">
            <div class="flex items-center bg-slate-800/50 px-2 py-1 rounded-full border border-slate-700">
                <span id="sala-dot" class="online-dot is-offline"></span>
                <span id="sala-status" class="text-[9px] font-bold uppercase text-slate-400">Sala Offline</span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col gap-4 max-w-md mx-auto w-full">
        
        <div id="box-risposta" class="hidden animate-pulse">
            <div class="bg-blue-600/20 border-2 border-blue-500 p-3 rounded-xl">
                <p class="text-[10px] font-black uppercase text-blue-400 mb-1">Ultima risposta dalla Sala:</p>
                <p id="testo-risposta" class="text-sm font-bold text-white"></p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="window.statoRapido('IN PARTENZA üöö', 'Uscita')" class="btn-status bg-amber-500 p-4 rounded-xl font-black text-[11px] uppercase text-slate-900 text-center">üöö Partenza</button>
            <button onclick="window.statoRapido('SUL POSTO üö®', 'Intervento')" class="btn-status bg-red-600 p-4 rounded-xl font-black text-[11px] uppercase text-center">üö® Sul Posto</button>
            <button onclick="window.statoRapido('OPERATIVI ‚ö°', 'In Corso')" class="btn-status bg-blue-600 p-4 rounded-xl font-black text-[11px] uppercase text-center">‚ö° Operativi</button>
            <button onclick="window.statoRapido('RIENTRO IN SEDE üè†', 'Rientro')" class="btn-status bg-emerald-600 p-4 rounded-xl font-black text-[11px] uppercase text-center">üè† Rientro</button>
        </div>

        <div class="h-[1px] bg-slate-800 my-1"></div>

        <div class="flex flex-col gap-1">
            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Nota extra o messaggio</label>
            <textarea id="messaggio" rows="3" 
                class="w-full p-3 bg-slate-800 border-2 border-slate-700 rounded-xl text-white font-bold focus:border-blue-500 outline-none resize-none" 
                placeholder="Scrivi qui..."></textarea>
        </div>

        <div class="flex items-center justify-between p-3 bg-slate-800/50 border border-slate-700 rounded-xl">
            <div class="flex flex-col">
                <span class="text-xs font-bold uppercase">Invia posizione GPS</span>
                <span class="text-[9px] text-slate-500 uppercase">Privacy attiva</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="toggle-gps" checked>
                <span class="slider"></span>
            </label>
        </div>

        <button id="btn-invia" onclick="window.inviaDati()" 
            class="w-full py-4 bg-white text-slate-950 rounded-xl font-black text-lg uppercase transition-all shadow-xl active:scale-95">
            Invia Messaggio
        </button>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, update, onValue, query, orderByChild, equalTo, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAWHRpXkth-UrnaDVo7GyeFNXpu10_fd54", databaseURL: "https://realtime-database-6962f-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const squadraId = urlParams.get('id') ? urlParams.get('id').toUpperCase() : "SCONOSCIUTA";
        document.getElementById('label-squadra').innerText = "UNIT√Ä: " + squadraId;

        // 1. MONITORAGGIO STATO SALA OPERATIVA
        onValue(ref(db, ".info/connected"), (snap) => {
            const dot = document.getElementById('sala-dot');
            const txt = document.getElementById('sala-status');
            if (snap.val()) {
                dot.className = "online-dot is-online";
                txt.innerText = "Sala Online";
                txt.className = "text-[9px] font-bold uppercase text-emerald-400";
            } else {
                dot.className = "online-dot is-offline";
                txt.innerText = "Sala Offline";
                txt.className = "text-[9px] font-bold uppercase text-red-500";
            }
        });

        // 2. ASCOLTO RISPOSTE DALLA SALA (Solo per questa squadra)
        const logRef = query(ref(db, 'brogliaccio'), orderByChild('squadra'), equalTo(squadraId), limitToLast(5));
        onValue(logRef, (snap) => {
            const logs = snap.val();
            if (logs) {
                const lastLog = Object.values(logs).reverse().find(l => l.m2 && l.m2 !== "---");
                if (lastLog) {
                    document.getElementById('box-risposta').classList.remove('hidden');
                    document.getElementById('testo-risposta').innerText = lastLog.m2;
                    // Notifica sonora o vibrazione se supportata
                    if ("vibrate" in navigator) navigator.vibrate(200);
                }
            }
        });

        window.statoRapido = (testoStato, valoreStato) => {
            const extra = document.getElementById('messaggio').value.trim();
            const messaggioFinale = extra ? `${testoStato} - ${extra}` : testoStato;
            window.inviaDati(messaggioFinale, valoreStato);
        };

        window.inviaDati = async (msgForzato = null, statoForzato = null) => {
            const msgInput = document.getElementById('messaggio');
            const btn = document.getElementById('btn-invia');
            const gpsEnabled = document.getElementById('toggle-gps').checked;
            const testo = msgForzato || msgInput.value.trim();

            if (!testo) return;

            btn.disabled = true;
            btn.innerText = "INVIO...";

            if (gpsEnabled) {
                navigator.geolocation.getCurrentPosition(
                    async (p) => { await spedisci(testo, p.coords.latitude, p.coords.longitude, statoForzato); },
                    async () => { await spedisci(testo, "", "", statoForzato); },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                await spedisci(testo, "", "", statoForzato);
            }
        };

        async function spedisci(m, la, lo, nuovoStato) {
            try {
                const ora = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                await push(ref(db, 'brogliaccio'), {
                    ora, squadra: squadraId, m1: m, m2: "", lat: la || "", lng: lo || "", stato: 'ATTESA', dir: 'SQ'
                });
                const updates = {};
                if (la && lo) { updates.lat = la; updates.lng = lo; }
                if (nuovoStato) { updates.stato = nuovoStato; }
                if (Object.keys(updates).length > 0) await update(ref(db, `anagrafica_squadre/${squadraId}`), updates);
                document.getElementById('messaggio').value = "";
                Swal.fire({ icon: 'success', title: 'Inviato', timer: 800, showConfirmButton: false });
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Errore' });
            } finally {
                btn-invia.disabled = false;
                btn-invia.innerText = "INVIA MESSAGGIO";
            }
        }
    </script>
</body>
</html>
