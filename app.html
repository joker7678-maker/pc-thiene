// --- RICEZIONE TARGET E AGGIORNAMENTO LOG ---
onValue(query(ref(db, 'brogliaccio'), limitToLast(5)), (snap) => {
    const logs = snap.val();
    if (logs) {
        Object.entries(logs).reverse().forEach(([key, log]) => {
            if (log.squadra === sqId && log.lat && log.lng && log.stato === 'ATTESA') {
                
                Swal.fire({
                    title: 'ðŸ“ NUOVO TARGET',
                    text: log.m1,
                    icon: 'warning',
                    confirmButtonText: 'CONFERMA RICEZIONE',
                    allowOutsideClick: false,
                    background: '#1e293b', color: '#fff', confirmButtonColor: '#10b981'
                }).then((res) => {
                    if (res.isConfirmed) {
                        // AGGIORNO LO STESSO LOG:
                        // 1. Stato passa a OK (smette di lampeggiare)
                        // 2. Aggiungo la conferma nel campo m2 (Risposta Sala/Squadra)
                        update(ref(db, `brogliaccio/${key}`), { 
                            stato: 'OK',
                            m2: `âœ… RICEVUTO DA ${sqId} ORE ${new Date().toLocaleTimeString('it-IT').slice(0,5)}`
                        });
                    }
                });
            }
        });
    }
});
